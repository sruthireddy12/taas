<div class="content-wrapper">
  <div class="cnt-head">
    <h1>Applications</h1>
    <%if current_user.is_super_admin? || current_user.is_organization_admin?%>
      <label id="new-application"><span><img src="/assets/plus-icon.png" width="16" height="16" alt="plus" /></span>Add Application</label>
    <%end%>
  </div>
  <% @organizations.each do |organization|%>
    <% if current_user.is_super_admin? %>
      <div class="org-app-bar show-app" organization-id="<%= organization.id%>">
        <h1><span><%= organization.domain.split('.')[0].upcase %></span></h1>
      </div>
      <div class="application-detail-<%=organization.id%>" style="display: none;">
    <%end%>
        <table class="tbl-1 alternate-color" id="alternatecolor" width="100%" border="0" cellspacing="0" cellpadding="0" style="float:left;">
          <tr>
            <th align="left" valign="middle">Name</th>
            <th align="left" valign="middle">URL</th>
            <th align="left" valign="middle">Created By</th>
            <th align="middle" valign="middle" colspan="3">Actions</th>
          </tr>
          <% organization.applications.each do |application| %>
            <tr>
              <td><%= link_to_if(action_active(application,'view'),application.name,{ controller: "applications", action: "show", id: application} , {class: 'view-link' }) %></td>
              <td><%= application.url %></td>
              <td><%= application.creator.full_name || application.creator.email %></td>
              <td>
                <%= link_to 'Edit', { controller: "applications", action: "edit", id: application}, {class: 'edit-link' } if action_active(application,'edit')%>
              </td>
              <td>
                <%= link_to 'Delete', application, :method => :delete, :data => { :confirm => 'Are you sure?' } if action_active(application) %>
              </td>
              <td>
                <%= link_to 'Assign', { controller: "roles_users", action: "index", id: application}, {class: 'assign_role_user' } if action_active(application,'assign_role')%>
              </td>
            </tr>
          <%end%>
        </table>
    <% if current_user.is_super_admin? %>
      </div>
    <%end%>
    <br \>
  <%end%>
</div>
  <script type="text/javascript">
    function submitForm() {
      elem.fileupload('send', {files: filesList, paramName: paramNames});
      if( filesList.length == 0 )
        elem.submit();
      $(this).dialog("close");
    }

    $("#new-application").on("click", function (e) {
      e.preventDefault();
      var tag = $("<div id=\"dialog-form\"></div>"),
        url = 'applications/new';
      $.ajax({
        url: url,
        success: function(data) {
          tag.html(data).dialog({
            modal: true,
            height: 800,
            width: 1200,
            open: function (event, ui) {
              $('.ui-widget-overlay').addClass('override');
            },
            title: 'Create new Application',
            buttons: [
              {
                text: "Save Application",
                "class": 'btn-style',
                click: submitForm
              },
              {
                text: "Cancel",
                "class": 'btn-style-2',
                click: function() {
                  $(this).dialog("close")
                }
              }
            ]
          }).
          dialog('open');
        }
      });
    });

    $(".view-link").on("click", function (e){
        e.preventDefault();
        var tag = $("<div></div>"),
          url = $(this).attr('href');
        $.ajax({
          url: url,
          success: function(data) {
            tag.html(data).dialog({modal: true,
              height: 800,
              width: 1200,
              open: function (event, ui) {
                $('.ui-widget-overlay').addClass('override');
              },
              title: 'Application Details',
              buttons: [
                {
                  text: "Cancel",
                  "class": 'btn-style-2',
                  click: function() {
                    $(this).dialog("close")
                  }
                },
              ]
            }).
            dialog('open');
          }
        });
    });

    $(".edit-link").on("click", function (e){
        e.preventDefault();
        var tag = $("<div></div>"),
          url = $(this).attr('href');
        $.ajax({
          url: url,
          success: function(data) {
            tag.html(data).dialog({modal: true,
              height: 800,
              width: 1200,
              open: function (event, ui) {
                $('.ui-widget-overlay').addClass('override');
              },
              title: 'Edit Application',
              buttons: [
                {
                  text: "Save Application",
                  "class": 'btn-style',
                  click: submitForm
                },
                {
                  text: "Cancel",
                  "class": 'btn-style-2',
                  click: function() {
                    $(this).dialog("close")
                  }
                }
              ]
            }).
            dialog('open');
          }
        });
    })

    $(document).on("click",".assign_role_user", function (e){
      e.preventDefault();
      var tag = $("<div></div>"),
        url = $(this).attr('href');
      $.ajax({
        url: url,
        success: function(data) {
          tag.html(data).dialog({modal: true,
            height: 500,
            width: 1012,
            title: 'Assign User Roles',
            open: function (event, ui) {
              $('.ui-widget-overlay').addClass('override');
            },
            beforeClose: function(event, ui) { 
              window.location.reload();
            },
            buttons: [
              {
                text: "Assign",
                "class": 'btn-style',
                "disabled": "disabled",
                "id": "submit",
                click: submitRole
              },
              {
                text: "Cancel",
                "class": 'btn-style-2',
                click: function() {
                  $(this).dialog("close")
                },
              }
            ]
          }).
          dialog('open');
        }
      });
    });

    function submitRole(){
      assign_roles()
    }

   $(document).on("click", '.show-app', function(e) {
    var organizationId = $(this).attr('organization-id')
    var finalDivId = ".application-detail-"+organizationId
       $(this).parent('div').parent().find(finalDivId).toggle();
   });
  </script>

